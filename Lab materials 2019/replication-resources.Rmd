---
title: "Resources for replication project"
author: "Gabriel Tarriba"
date: "April 29, 2019"
output: html_document
---

```{r message = FALSE, warning=FALSE}
library(wooldridge)
library(stargazer)
library(tidyverse)
```

# Answers to questions from last week:

* Q1: *How to know whether my knitted html file is about 8 pages long?* 
    + Use print preview function. But length isn't that important - just don't write more than necessary.
* Q2: *In Paper 2, Fig. 2, can I plot the two graphs separately instead of superimposing them?* 
    + Yes
* Q3: *In paper 2, to replicate tables 7 and 9, I need to perform Coarsened Exact Matching and then LOESS regression, right?* 
    + Yes, CEM works with matchit(method = "cem")
* Q4 *Are the paper-specific instructions exhaustive?* 
    + Yes, you're not supposed to replicate other stuff that's reported in the text or in other materials.
* Q5: *Can I download the data in .Rdata format instead of .dta?*
    + Yes, for papers 2 and 3. Just open the drop-down menu located on the Download button in the Dataverse. Data for paper 1 is only available in .dta format. You can then load the data using the command get(load("path/file.Rdata"))
    ```{r, echo = TRUE, results='hide'}
    # Example
    get(load('3/naval_rep_data.Rdata'))
    ```
* Q6: * In Paper 3 , instead of the DAG students can "Visualize the time-series of the core dependent variable and the core independent
variable (tonnage) by country", but there are over 100 countries. Can we just plot a reasonable number of them?
  + No, show all countries, you can split them into several plots.
* Q7: In Paper 2, to replicate Fig. 2, is smoothing of the local regression plot necessary (as in the original)? Or is it fine if we present a plot as the one in lines 93-98 of the W07 script?
  +  You can do it in a separate plot - as we did in the RD class. 
* Q8: In Paper 3, is there any way to estimate the predicted probabilities (to replicate figs. 1 and 2) other than by hand? The documentation of ivprobit seems to be quite limited in this regard?
  + It's OK to do it by hand, see advice below. You don't have to include confidence intervals.

# General resources

In the Lab section on Moodle you will find relevant resources on:

* RMarkdown
* dplyr (for data manipulation)
* ggplot2 (graphs)
* stargazer (for tables of summary statistics and regression results)
* ggdag (for DAGs)
* R for Data Science e-book (good R reference manual)

# General advice

* Pay attention to the chunk options! Learn about them in the [RMarkdown Cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf)
* Remember that graphs and tables should contain the same information as the originals and look similar, but not necessarily identical!
* Read carefully the notes of tables of regression results, often they specify important information about the models
* Use the command nobs() to check the number of observations considered in each model and compare it to the authors' models
* If your regression results are very similar, but not identical, to the original ones and you can't figure out why, just explain this in your paper and move on
* Stargazer allows you to display nicely the results of one or multiple models in a table, but you might have to tinker with the format a bit in order to get what you want. [Check out Jack Russ's excellent cheatsheet](https://www.jakeruss.com/cheatsheets/stargazer/) or the [actual reference manual](https://cran.r-project.org/web/packages/stargazer/stargazer.pdf)
* If you use Stargazer, don't forget to set results='asis' in the chunk options!
```{r, header = FALSE, results ='asis'}

# Stargazer example
data("wage1")
# Summary statistics
stargazer(wage1, 
          title = "Descriptive statistics",
          type = "html", 
          keep = c("educ", "nonwhite", "female", 
                   "exper", "expersq", "tenure"),
          omit.summary.stat = c("min", "max", "p25", "p75"),
          covariate.labels=c("Education (yrs)",
                             "Non-White", "Female","Experience", 
                             "Experience sq.", "Tenure"),
          digits=2,
          column.sep.width = "7pt")
m1 <- lm(wage ~ educ, data = wage1) 
m2 <- lm(wage ~ educ + nonwhite + female, data = wage1)
m3 <- lm(wage ~ educ + nonwhite + female + exper + expersq + tenure, data = wage1)

# Regression output
stargazer(m1, m2, m3, type = "html",
          title = "OLS results",
          dep.var.labels=c("Hourly wage (1976 USD)"),
          covariate.labels=c("Intercept","Education (yrs)",
                             "Non-White", "Female","Experience", 
                             "Experience sq.", "Tenure"),
          intercept.bottom = FALSE,
          digits=3)

```


# Paper-specific resources and advice

## Paper 1

* [Codebook of ESS wave 7 available here](https://www.europeansocialsurvey.org/docs/round7/survey/ESS7_appendix_a7_e01_0.pdf)
* For Fig. 1, you may want to get your data into the [right format first, using group_by and summarize](https://r4ds.had.co.nz/transform.html#grouped-summaries-with-summarise) 
* There are different ways of plotting multiple lines in one graph, you can [have a look here](https://stackoverflow.com/questions/3777174/plotting-two-variables-as-lines-using-ggplot2-on-the-same-graph) or [here](https://rpubs.com/euclid/343644)
* To plot subsets of data together (i.e. by country) [have a look at facets](http://www.cookbook-r.com/Graphs/Facets_(ggplot2)/)
* To modify graph legend and labels, [have a look here](https://www.datanovia.com/en/blog/ggplot-legend-title-position-and-labels/) and [here](https://stackoverflow.com/questions/23635662/editing-legend-text-labels-in-ggplot)
* To add vertical lines to graphs, [see here](http://www.sthda.com/english/wiki/ggplot2-add-straight-lines-to-a-plot-horizontal-vertical-and-regression-lines)
* Tables 3 and 4 can be created with stargazer. Read well the table notes!
* DAGs can be created with ggdag, check the R script from Week 2

## Paper 2

* [Codebook of ESS wave 6 available here](https://www.europeansocialsurvey.org/docs/round6/survey/ESS6_appendix_a7_e01_0.pdf)
* You need to prepare the data first! Have a look at the Stata do file, lines 21-100
* There are multiple ways of replicating Table 1, [here is one](https://sebastiansauer.github.io/multiple-t-tests-with-dplyr/)
* You may recreate Fig. 2 as two side-by-side plots
* In Fig.2 don't forget that each point on the line is a 2-day moving average of the dependent variable.
* For details on how to 'slice' the data to plot two discontinuous lines as in Fig. 2, [see here](https://mgimond.github.io/ES218/Week10b.html)
* Table 2 is a standard regression output table that can be handled by stargazer
* For Fig. 3 you first need to estimate the treatment effects for 20 different operationalizations of the treatment group, depending on the latest date of interview considered - store these coefficients in a new dataframe and then plot them!
* Figs. 1 and 2 are predicted probability plots - [this could help](https://druedin.com/2016/01/16/predicted-probabilities-in-r/)
* Table 7 (from the [Online Appendix](https://journals.sagepub.com/doi/suppl/10.1177/2053168017714185/suppl_file/Supplementary_materials_Ares_Hernandez.pdf)) can be handled by stargazer after you perform [Coarsened Exact Matching](https://gking.harvard.edu/cem) using matchit
* Table 9 shows the results of RDD analysis with local linear regression - you can use RDestimate (see Simon's script from W07). For more details on this method [see here](http://www.ucdenver.edu/academics/colleges/PublicHealth/resourcesfor/Faculty/perraillon/perraillonteaching/Documents/hrs_rdd_slides_h.pdf)

## Paper 3

* To estimate the models, you will need to run the ivprobit command from [the namesake package](https://mpra.ub.uni-muenchen.de/72383/1/MPRA_paper_72383.pdf)
* Note that the formula is y~x|y1|x2, where *y is the dichotomous l.h.s.,x is the r.h.s. exogenous variables, y1 is the r.h.s. endogenous variables and x2 is the complete set of instruments*. The complete set of instruments includes the control variables!
# To estimate the predicted probabilities, plug in the coefficients and means of all covariates, and vary the value of the endogenous variable, to obtain the corresponding probability (i.e. the value of Y). Some steps:
    1. Estimate the model and save the coefficients
    2. Save the means of the variables in the model
    3. Choose a value of the endogenous variable
    4. Plug in all the values (coefficients, means of variables, given level of endogenous variable) to get z-value
    5. Get the predicted probability associated to that z-value by estimating the inverse probit function with pnorm()
    6. Choose another value of the endogenous variable and repeat steps 1-6


