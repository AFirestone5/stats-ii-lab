 ---
title: "Statistics II Lab - Spring 2019 - W03"
author: "Gabriel Tarriba"
date: "April 4, 2019"
output: html_document
---

```{r include = FALSE}
source("packages.r")
library(stargazer)
```

# 1. Review of the lecture
  
## Interrupted Time Series (ITS)
    * If you want to learn more (example from public health): 
    
```{r, include = F}
browseURL("https://academic.oup.com/ije/article/46/1/348/2622842")
```

## Differences-in-Differences estimation
    * Why is it better than other strategies (Before vs After, Treated vs Control in post period)? - Slide 16
    * Why is the parallel trends assumption important: No counterfactual for T group in post period - Slides 18 & 19
    * Regression estimation of DiD Slide 26
    * For a graphical explanation of DiD:
    
```{r, include = F}
browseURL("https://www.mailman.columbia.edu/research/population-health-methods/difference-difference-estimation")
```
    * How can the parallel trends assumption be violated? Slide 29
    * Real-world examples:
        + Munzert & Selb (2018): Hitler's speeches and NSDAP local vote (Table I1 shows the DiD estimators: Time trend is the time dummy, Base rate difference is the Control-Treatment dummy, Exposure 10 km is the interaction) 
        
```{r, include = F}
browseURL("https://static.cambridge.org/resource/id/urn:cambridge.org:id:binary:20181009122639786-0209:S0003055418000424:S0003055418000424sup001.pdf")
```
       + Card & Krueger (1994): How do minimum wage increases affect employment? http://davidcard.berkeley.edu/papers/njmin-aer.pdf 
        + The Economist's obituary of Alan Krueger discussed this paper: https://www.economist.com/finance-and-economics/2019/03/21/alan-krueger-natural-talent
        + List of application papers: 
```{r, include = F}
browseURL("https://www.mailman.columbia.edu/research/population-health-methods/difference-difference-estimation")
```
   
  * If you are still a bit lost with Diff-in-Diff, watch this short video (12 min) video by Doug McKee (Cornell):
```{r}
browseURL("https://www.youtube.com/watch?v=J7q2H8aB8bQ")
```
     
## Fixed Effects
    * What variation do we actually analyse when we use FE?
    * What are the main limitations of FE?
    * In case you are still a bit unsure as to what FE doe, check out this short (8 min) introduction to FE by Ben Lambert (Imperial College London): 
```{r, include = F}
browseURL("https://www.youtube.com/watch?v=sFvV9b1cGFc")
```

# 2. R script for W06

## Diff-in-diff example: Workers' compensation and injury duration
```{r, include=F}
browseURL("https://www.jstor.org/stable/2118177?seq=4#metadata_info_tab_contents")
```
  * RQ: Does the level of workers' injury compensation affect the average injury duration?
  * Natural experiment setting: Level of compensation was raised for high earners in Kentucky and Michigan in the early 1980s
    + We can compare avg injury time before and after the change
    + We can use low earners as the control group
  * Key variables
    + Dep. var.: Duration of benefits (durat)(Unit: days?)
    + Post-treatment period dummy: afchnge
    + D (Treatment group dummy): highearn (=1 if high earner)
    
## Fixed Effects Estimation: Comparative Political Data Set, 1960-2015
```{r, include = F}
browseURL("http://www.cpds-data.org/images/Update2017/Codebook-CPDS-1960-2015-Update-2017.pdf")
```
  * Key variables:
    + year
    + country
    + iso (3-Letter country code)
    + gov_left2: parliamentary share of the left in ruling coalition   
    + socexp_t_pmp: Total public and mandatory private social expenditure as a percentage of GDP
    + instcons: Index of institutional constraints of central state government, Minimum value = 0; Maximum value = 6
    + unemp: Unemployment rate, percentage of civilian labour force
    + eu: Dummy variable with value 1 for member states of the European Union
  * RQ: Does social expenditure increase under left-wing governments?
  * Dep. Var: Social expenditure (socexp_t_pmp)
  * Key explanatory variable: Share of the left in govt (gov_left2)
  * Controls: Institutional constraints (instcons), Unemployment (unemp)

# 3. Assignment 5 - Hints!

## Problem 2
    * (a) Very easy
    * (b) Consider: What's the difference between explaining the differences in LEVELS of letter recognition between the groups and explaining the CHANGE in letter recognition between the groups?
    * (c) Assumptions needed for a causal interpretation of the results of (b)
    * (d) How to make your data "long" (one row for each unit and each time period) rather than "wide" (time periods in multiple columns):
        + Check out the relevant section in Hadley Wickham's book:
        
```{r, include = FALSE}
browseURL("https://r4ds.had.co.nz/tidy-data.html#gathering")
```
        
##  Example involving Diff-in-Diff and making data wide to long:

  * Scientists want to find out if caffeine boosts Hertie students' concentration.
    200 students are randomly selected for the experiment into roughly equal treatment
    and control groups. 
  * Experimental setup: Early in the day, both groups take a cognitive test.
    Afterwards, individuals in the treatment must drink a double espresso while 
    individuals in the control group are forbidden from consuming caffeine. After
    that, both groups take the test again and we estimate the DiD. 

```{r}
set.seed(99)
pre_score <- rnorm(200, 70, 4)
treat <- X <- rbinom(200, 1, 0.5)
post_score <- rnorm(200, 75, 4) + 5*treat
dat <- data.frame(cbind(pre_score, post_score, treat))

# Check balance
mean(dat$treat == 0)

# Check the means of the groups before and after
mean(dat$pre_score[dat$treat == 0])
mean(dat$pre_score[dat$treat == 1])
mean(dat$post_score[dat$treat == 0])
mean(dat$post_score[dat$treat == 1])

# The data is in wide form (one row per subject, containing all  time points). We need to make the data LONG (i.e. each row contains one subject at one time point). For this we use gather() from dplyr
# If you are confused about what this means:
browseURL("https://www.theanalysisfactor.com/wide-and-long-data/")
browseURL("https://sejdemyr.github.io/r-tutorials/basics/wide-and-long/")

dat_long <- gather(dat, time, score, pre_score, post_score)

# We're almost done! We just need to convert timeperiod into a binary numerical variable (0,1). We can use ifelse:
# ifelse(condition, value if true, value if false)

dat_long <- mutate(dat_long, post = ifelse(time == "pre_score", 0, 1))

# We now have the three variables that we need for DD estimation: the dependent variable score, the treatment variable treat, and the time period variable post

summary(lm(score ~ treat*post, data = dat_long))
```

## Problem 3
  * (a) Run pooled OLS (ignore state fixed effects and year fixed effects)
  * (b) FE model with state fixed effects. Remember the arguments:

model_fe <- plm(dep_var ~ var_1 + var_2 + ..., data = dataset_name, index = c("id_var", "time_var"), model = "within"))

  * (c) To add time fixed effects, add a come to the previous model after model = "within" and write effect = "twoways"
  



    